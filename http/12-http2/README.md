# HTTP/2

HTTP/2是现行HTTP协议（HTTP/1.x）的替代，但它不是重写，HTTP方法/状态码/语义都与HTTP/1.x一样。HTTP/2 修改了数据格式化（分帧）以及在客户端与服务器间传输的方式。HTTP/2基于SPDY3，**专注于性能，最大的一个目标是在用户和网站间只用一个连接**。

HTTP/2 通过支持完整的请求与响应复用来减少延迟，通过有效压缩 HTTP 报头字段将协议开销降至最低，同时增加对请求优先级和服务器推送的支持。

HTTP/2 协议由以下两个 RFC 组成：

1）RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)；

2） RFC 7541 - HPACK: Header Compression for HTTP/2；

 

## 解决的问题

影响一个HTTP网络请求的因素主要有两个：**带宽和延迟**。当今网络情况下，主要瓶颈是**延迟**

延迟的原因: 

**1）浏览器线头阻塞（Head-Of-Line Blocking）**：浏览器会因为一些原因阻塞请求。

**2）DNS查询。**

**3）建立连接（Initial connection）**：HTTP基于 TCP 协议，TCP的**3次握手和慢启动**极大增加延迟。

 

### HTTP/1.x存在的问题

1）**连接无法复用**：连接无法复用会导致**每次请求都经历三次握手和慢启动**。三次握手在高延迟的场景下影响较明显，慢启动则对文件类大请求影响较大。

- HTTP/1.0传输数据时，每次都需要重新建立连接，增加延迟。
- HTTP/1.1虽然加入keep-alive，可以复用一部分连接，但域名分片等情况下仍然需要建立多个connection，耗费资源，给服务器带来性能压力。

2）**线头阻塞（Head-Of-Line Blocking）**：导致带宽无法被充分利用，以及后续健康请求被阻塞。HOLB是指在HTTP/1.x中，由于服务器必须按接受请求的顺序发送响应的规则限制，那么假设浏览器在一个（tcp）连接上发送了两个请求，那么服务器必须等第一个请求响应完毕才能发送第二个响应——HOLB。虽然现在浏览器允许每个origin建立6个connection，但大量网页动辄几十个或上百个资源，HOLB依然是主要问题。

3）**协议开销大**：HTTP/1.x中header内容过大（每次请求header基本不怎么变化），增加了传输的成本。

4）**安全因素**：在HTTP中传输的内容都是明文，客户端和服务端双方无法验证身份。

 

### HTTP/2解决的问题

1）**连接复用**：在用户和网站之间只用一个连接，避免后续建立连接过程中的几个往返和慢启动，同时减少了服务器的资源消耗。

2）**没有线头阻塞**：采用新的二进制分帧层的机制，组成消息的帧可以乱序发送，帧到达对端重新组装，不需要等待前面的帧到达后再发送。

3）**报头压缩**：HTTP/2协议中采用HPACK来压缩请求头和响应头，降低协议开销。

4）**更加安全**：当前主流浏览器，都只支持基于HTTPS部署的HTTP/2

 

## HTTP/2协议的新特性

### 二进制分帧层

二进制分帧层定义了如何封装HTTP消息并在客户端和服务器之间传输，和HTTP/1.x对比如下图

![计算机生成了可选文字: 的 用 m11P2 叫  二 制 分  会 括 层 { ， L 引 可 选 ，  1 输 层 门 ℃ 以  网 络 以 (If')  丨 P11  nST 'upload HTTP/I.I  Host: www.eumple.org  “ 禰 ． ea 咿 ic 叫  t ． Le 丨 h ： 15  rm ： № 1  HEADERSÉ  DA ， 1 ](file:///C:/Users/94046/AppData/Local/Temp/msohtmlclip1/01/clip_image001.png)

 

所谓的“层”，指的是位于套接字接口与应用可见的高级 HTTP API 之间一个经过优化的新编码机制：HTTP 的语义（包括各种动词、方法、标头）都不受影响，不同的是传输期间对它们的编码方式变了。HTTP/1.x 协议以换行符作为纯文本的分隔符，而 HTTP/2 将所有传输的信息分割为更小的消息和帧，并采用二进制格式对它们编码。

 

问题：HTTP/1.x 客户端无法理解只支持 HTTP/2 的服务器

###  数据流、消息和帧

- 数据流：已建立的连接内的双向字节流，可以承载一条或多条消息。

- 消息：与逻辑请求或响应消息对应的完整的一系列帧。

- 帧：HTTP/2 通信的最小单位，每个帧都包含帧头，至少也会标识出当前帧所属的数据流。

以上概念关系总结如下：

- 所有通信都在一个 TCP 连接上完成，此连接可以承载任意数量的双向数据流。
- 每个数据流都有一个唯一的标识符和可选的优先级信息，用于承载双向消息。
- 每条消息都是一条逻辑 HTTP  消息（例如请求或响应），包含一个或多个帧。

 

**帧是最小的通信单位**，承载着特定类型的数据，例如 HTTP 标头、消息负载等等。 来自不同数据流的帧可以交错发送，然后再根据每个帧头的数据流标识符重新组装。

HTTP/2 将 HTTP 协议通信分解为二进制编码帧的交换，这些帧对应着特定数据流中的消息。**所有这些都在一个 TCP 连接内复用。这是 HTTP/2 协议所有其他功能和性能优化的基础**

 

### 多路复用

在 HTTP/1.x 中，如果客户端要想发起多个并行请求以提升性能，则必须使用多个 TCP 连接。因为HTTP/1.x 交付模型设定，每个连接每次只交付一个响应（响应排队），导致队首阻塞，TCP链接的效率的低下。

HTTP/2 中新的二进制分帧层突破了这些限制，实现了完整的请求和响应复用：客户端和服务器可以将 HTTP 消息分解为互不依赖的帧，然后交错发送，最后再在另一端把它们重新组装起来。

 

![计算机生成了可选文字: H P2 ． 釹 “ " ect  0 HEADERS ](file:///C:/Users/94046/AppData/Local/Temp/msohtmlclip1/01/clip_image003.png)

- 并行交错地发送多个请求，请求之间互不影响。
- 并行交错地发送多个响应，响应之间互不干扰。
- 使用一个连接并行发送多个请求和响应。
- 不必再为绕过 HTTP/1.x      限制而做很多工作（对 HTTP/1.x 进行优化，例如级联文件、image sprites 和域名分片。
- 消除不必要的延迟和提高现有网络容量的利用率，从而减少页面加载时间。

 

**HTTP/2 中的新二进制分帧层解决了 HTTP/1.x 中存在的队首阻塞问题**，也消除了并行处理和发送请求及响应时对多个连接的依赖。结果，应用速度更快、开发更简单、部署成本更低

 

### 请求重置

HTTP 1.1的有一个缺点是：当一个含有确切值的Content-Length的HTTP消息被送出之后，你就很难中断它了。除非断开整个TCP链接。

**HTTP/2里面，我们可以通过发送RST_STREAM帧来实现这种需求，从而避免浪费带宽和中断已有的连接**

 

### **请求优先级**

HTTP/2 标准允许每个数据流都有一个关联的权重和依赖关系：

- 可以向每个数据流分配一个介于 1 至 256 之间的整数。
- 每个数据流与其他数据流之间可以存在显式依赖关系。

数据流依赖关系和权重的组合让客户端可以构建和传递“优先级树”，表明它倾向于如何接收响应。反过来，服务器可以使用此信息通过控制 CPU、内存和其他资源的分配设定数据流处理的优先级，在资源数据可用之后，带宽分配可以确保将高优先级响应以最优方式传输至客户端。

![计算机生成了可选文字: implicit root  weight  了 ， 騍 冱 詿 ](file:///C:/Users/94046/AppData/Local/Temp/msohtmlclip1/01/clip_image004.png)

 

如上图，HTTP/2 内的数据流依赖关系通过将另一个数据流的唯一标识符作为父项引用进行声明；如果忽略标识符，相应数据流将依赖于“根数据流”。声明数据流依赖关系指出，应尽可能先向父数据流分配资源，然后再向其依赖项分配资源。换句话说，“请先处理和传输响应 D，然后再处理和传输响应 C”。



共享相同父项的数据流（即，同级数据流）应按其权重比例分配资源。

数据流依赖关系和权重的组合明确表达了资源优先级，这是一种用于提升浏览性能的关键功能，网络中拥有多种资源类型，它们的依赖关系和权重各不相同。不仅如此，HTTP/2 协议还允许客户端随时更新这些优先级，进一步优化了浏览器性能。换句话说，我们可以根据用户互动和其他信号更改依赖关系和重新分配权重。

数据流依赖关系和权重表示传输优先级，而不是要求，因此不能保证特定的处理或传输顺序。

 

### 每个来源一个连接

有了新的分帧机制后，HTTP/2 不再依赖多个 TCP 连接去并行复用数据流；每个数据流都拆分成很多帧，而这些帧可以交错，还可以分别设定优先级**。**因此，所有 HTTP/2 连接都是永久的，而且仅需要每个来源一个连接，随之带来诸多性能优势。

 

在HTTP/2 RFC文档中建议实现时客户端不应该在给定的目的地上打开多个HTTP/2连接，**目的地是由给定的URI确定的IP地址及TCP端口，或者配置的代理IP和端口**。当然客户端可以使用不相同的服务端名称标识值或者提供不一样的ssl证书对相同的IP地址及TCP端口打开多个连接，但应该避免对相同的配置上创建多个连接。

 

连接数量减少对提升 HTTPS 部署的性能来说是一项特别重要的功能：可以减少开销较大的 TLS 连接数、提升会话重用率，以及从整体上减少所需的客户端和服务器资源。

 

### 流量控制

流量控制是一种阻止发送方向接收方发送大量数据的机制，以免超出后者的需求或处理能力：发送方可能非常繁忙、处于较高的负载之下，也可能仅仅希望为特定数据流分配固定量的资源。

HTTP/2 提供了一组简单的构建块，这些构建块允许客户端和服务器实现其自己的数据流和连接级流量控制：

- **流量控制具有方向性**，每个接收方都可以根据自身需要选择为每个数据流和整个连接设置任意的窗口大小。
- **流量控制基于窗口更新帧进行**，即接收方广播自己准备接收某个数据流的多少字节，以及对整个连接要接收多少字节。
- **流量控制窗口大小通过WINDOW_UPDATE帧更新**，这个字段制定了流ID和窗口递增值。
- **流量控制可以由接收方禁用**，包括针对个别的流和针对整个连接。
- **流量控制基于每一跳进行，而非端到端控制**。即，可信中介可以使用它来控制资源使用，以及基于自身条件和启发式算法实现资源分配机制。

**HTTP/2 未指定任何特定算法来实现流量控制。**

 

### 服务器推送

HTTP/2 新增的另一个强大的新功能是，**服务器可以对一个客户端请求发送多个响应**

 

![计算机生成了可选文字: HTTP 2 ． on （ № n  山 ， ， St ， n'  prang  streaml / ge 懨 m (client request)  stream 2 ： cnp 的 ， (Push Omi ，  stream4. / 、 ， e ． “ 、 (push promise)  山 ， 2  一 小 运 缍 ](file:///C:/Users/94046/AppData/Local/Temp/msohtmlclip1/01/clip_image005.png)

HTTP/2 打破了严格的请求-响应语义，支持一对多和服务器发起的推送工作流，在浏览器内外开启了全新的互动可能性。这是一项使能功能，对我们思考协议、协议用途和使用方式具有重要的长期影响

推送资源可以进行以下处理：

- 由客户端缓存
- 在不同页面之间重用
- 与其他资源一起复用
- 由服务器设定优先级
- 被客户端拒绝

 

### PUSH_PROMISE 101

**所有服务器推送数据流都由 PUSH_PROMISE 帧发起，表明了服务器向客户端推送所述资源的意图****，**并且需要先于请求推送资源的响应数据传输。这种传输顺序非常重要：客户端需要了解服务器打算推送哪些资源，以免为这些资源创建重复请求。满足此要求的最简单策略是先于父响应（即，DATA帧）发送所有 PUSH_PROMISE 帧，其中包含所承诺资源的 HTTP 标头。

相比之下，使用资源内联（一种受欢迎的 HTTP/1.x“优化”）等同于“强制推送”：客户端无法选择拒绝、取消或单独处理内联的资源。

**使用 HTTP/2，客户端仍然完全掌控服务器推送的使用方式****。**

 

### 报头压缩

每个 HTTP 传输都承载一组报头，这些报头说明了传输的资源及其属性

 

 在 HTTP/1.x 中，此元数据始终以纯文本形式，通常会给每个传输增加 500–800 字节的开销。如果使用 HTTP Cookie，增加的开销有时会达到上千字节。为了减少此开销和提升性能， **HTTP/2 使用 HPACK 压缩格式压缩请求和响应标头元数据**，这种格式采用两种简单但是强大的技术：

- 这种格式支持通过静态      Huffman 编码对传输的标头字段进行编码，从而减小了各个传输的大小。
- 这种格式要求客户端和服务器同时维护和更新一个包含之前见过的标头字段的索引列表（换句话说，它可以建立一个共享的压缩上下文），此列表随后会用作参考，对之前传输的值进行有效编码。

 

**HPACK 压缩上下文包含一个静态表和一个动态表**

在 HTTP/2 中，请求和响应标头字段的定义保持不变，仅有一些微小的差异：所有标头字段名称均为小写，请求行现在拆分成各个 :method、:scheme、:authority 和 :path 伪标头字段。

 

 

## 性能测试结果

1.典型网络RTT下（50~200ms），HTTP/2对网络延迟性能有一定程度的提升，优于HTTP/1.x和HTTPS

2.在2xx和3xx请求下HTTP/2利用HPACK机制压缩响应头和请求头，有效降低了请求和响应的大小，节省了流量，降低了协议消耗

3.目前HTTP/2大部分流量来自于chrome，其对HTTP/2的支持性也是最好的

 

## 部署建议

如果你使用SSL/TLS（以后简称TLS），那么HTTP/2可以提升网站性能。如果你没有，那在使用HTTP/2之前要先支持TLS。这时候，**使用TLS的性能损耗大致可以被使用HTTP/2的性能提升抵销**。不过还是建议你在实际应用之前先测试一下。

 

## 优势和不足

HTTP/2有五大优势：

1. **每个服务器只用一个连接**。HTTP/2对每个服务器只使用一个连接，而不是每个文件一个连接。这样，就省掉了多次建立连接的时间，这个时间对TLS尤其明显，因为TLS连接费时间。
2. **加速TLS交付**。HTTP/2只需一次耗时的TLS握手，并且通过一个连接上的多路利用实现最佳性能。HTTP/2还会压缩首部数据，省掉HTTP/1.x时代所需的一些优化工作，比如拼接文件，从而提高缓存利用率。
3. **简化Web应用**。使用HTTP/2可以让Web开发者省很多事，因为不用再做那些针对HTTP/1.x的优化工作了。
4. **适合内容混杂的页面**。HTTP/2特别适合混合了HTML、CSS、JavaScript、图片和有限多媒体的传统页面。浏览器可以优先安排那些重要的文件请求，让页面的关键部分先出现，快出现。
5. **更安全**。通过减少TLS的性能损失，可以让更多应用使用TLS，从而让用户信息更安全。

 

相应地，HTTP/2也有五个不足之处：

1. **单连接开销比较大**。HPACK数据压缩算法会更新两端的查找表。这样可以让连接有状态，而破坏状态就意味着要重建查找表，另外单连接占用内存较多。
2. **你可能不需要SSL**。如果你的数据不需要保护，或者已经使用DRM或其他编码进行保护了，那么TLS的安全性对你可能无所谓。
3. **需要抛弃针对HTTP/1.x的优化**。HTTP/1.x优化在支持HTTP/2的浏览器中会影响性能，因此可能需要花时间把它们推倒重来。
4. **对下载大文件不利**。如果你的应用主要提供大文件下载或者流媒体播放，那可能不想用TLS，而且在只有一个流的情况下，多路复用也体现不出什么优势。
5. **你的客户也许不在乎**。你的客户很可能不在乎他分享的自家猫咪的视频是否受到TLS和HTTP/2的保护。

**总之，一切要看性能**。**对于要通过典型网络延迟请求的混合内容网页，HTTP/2的性能好于HTTP/1.x和HTTPS**



## 参考链接

[HTTP/2调研](https://wiki.n.miui.com/pages/viewpage.action?pageId=34833010)

[HTTP/2性能测试报告](https://wiki.n.miui.com/pages/viewpage.action?pageId=64189021)

