# 作用域是什么

> 2018-12-03 @wsl

## 1. 编译原理

JavaScript 引擎会在程序执行前进行编译，这个步骤与传统的编译语言非常类似。“编译”分为以下三步：

- 分词/词法分析（Tokenizing/Lexing）

  这个过程会将由字符组成的字符串分解成（对编程语言来说）有意义的代码块，这些代码块被称为词法单元（token）。

- 解析/语法分析（Parsing）

  这个过程是将词法单元流（数组）转换成一个由元素逐级嵌套所组成的代表了程序语法结构的树。这个树被称为”抽象语法树“（Abstract Syntax Tree, AST）。

- 代码生成

  将AST转换为可执行代码的过程被称为代码生成。



## 2. 理解作用域

### 1）概念

- 引擎

  负责整个JavaScript程序的编译及执行过程。

- 编译器

  负责词法分析、语法分析、代码生成等。

- 作用域

  负责收集并维护由所有声明的标识符（变量）组成的一系列查询，并实施一套非常严格的规则，确定当前执行的代码对这些标识符的访问权限。



### 2）变量的赋值操作

变量的赋值操作会执行两个步骤：

1. 编译器会询问当前作用域是否已经有一个该名称的变量存在于同一个作用域的集合中。如果是，编译器会忽略该声明，继续进行编译；否则在当前作用域中声明一个新的变量。
2. 在运行时引擎会在作用域中查找该变量，如果能找到就会对它赋值，如果找不到会抛出 ReferenceError 异常。

例如：

`var a = 2;` 这条语句，JavaScript 会将其看成两个声明： `var a;` 和 `a = 2;` 。第一个定义声明是在编译阶段进行的。第二个赋值声明会被留在原地等待执行阶段。



### 3）查询变量

可分为 LHS 查询和 RHS 查询。全称为 Left Hand Side和 Right Hand Side，即左手边和右手边。

一般可以理解为赋值操作的左侧和右侧，但不完全，可以理解为“赋值操作的目标是谁（LHS）”、“谁是赋值操作的源头（RHS）”。

例子：

```javascript
var a = 2; // LHS
console.log(a); // RHS
```

测试1：

试试找出其中的3处 LHS 查询，4处 RHS 查询

```javascript
function foo(a) {
    var b = a;
    return a + b;
}
var c = foo(2);
```



## 3. 作用域嵌套

当一个块或函数嵌套在另一个块或函数中时，就发生了作用域的嵌套。因此，在当前作用域中无法找到某个变量时，引擎就会在外层嵌套的作用域中继续查找，直到找到该变量，或抵达最外层的作用域（也就是全局作用域）为止。



## 4. 异常

- ReferenceError

  如果 **RHS 查询**在所有嵌套的作用域中遍寻不到所需的变量，引擎就会抛出ReferenceError异常。

  相较之下，当引擎执行 **LSH 查询**时，如果在顶层（全局作用域）中也无法找到目标变量，全局作用域中就会**创建一个具有该名称的变量**，并将其返还给引擎，前提是程序运行在**非“严格模式”**下。

  ES5中引入了“严格模式”。**严格模式禁止自动或隐式地创建全局变量**。因此，在严格模式中 LHS 查询失败时，并不会创建并返回一个全局变量，引擎会抛出ReferenceError异常。

- TypeError

  如果 RHS 查询找到了一个变量，但是尝试对这个变量的值进行不合理的操作，例如对非函数类型的值进行函数调用、引用 null 或 undefined 类型的值中的属性，那么引擎会抛出 TypeError 异常。

ReferenceError 同作用域判别失败相关，而 TypeError 则代表作用域判别成功了，但是对结果的操作是非法或不合理的。

测试2：

以下几个场景会输出什么？

```js
// 场景一
function foo(a) {
    console.log(a + b);
    b = a;
}
foo(2);
// 场景二
function foo(a) {
    b = a;
    console.log(a + b);
}
foo(2);
// 场景三
function foo(a) {
    console.log(a[0]);
}
foo();
```



## 参考链接

[第一章：什么是作用域？- You Dont Know JS](https://github.com/getify/You-Dont-Know-JS/blob/1ed-zh-CN/scope %26 closures/ch1.md)



## 附录

- 测试1答案：
LHS查询： c = .. 、a = 2 （隐式变量分配）、b = .. 
  RHS查询：foo(2)、= a、a ..、.. b
- 测试2答案：
场景一：会报错，ReferenceError: b is not defined
  场景二：不会报错，输出4
场景三：会报错，TypeError: Cannot read property '0' of undefined

